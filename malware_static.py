import re
import joblib
import pandas as pd
try:
    import pefile
except ImportError:
    pefile = None

# === Indicators ===
SUSPICIOUS_IMPORTS = ["WinExec", "CreateRemoteThread", "VirtualAlloc", "GetProcAddress", "LoadLibraryA"]
NETWORK_INDICATORS = [r"http://", r"https://", r"\.onion", r"tcp://", r"udp://"]

# Load the trained static malware model using joblib
model = joblib.load("models/malware_static_model.pkl")

def extract_strings(path, min_len=5):
    """Extract ASCII strings from binary file."""
    with open(path, "rb") as f:
        data = f.read()
    strings, curr = [], []
    for b in data:
        if 32 <= b <= 126:
            curr.append(chr(b))
        else:
            if len(curr) >= min_len:
                strings.append("".join(curr))
            curr = []
    if len(curr) >= min_len:
        strings.append("".join(curr))
    return strings

def pe_indicators(path):
    """Extract PE file indicators (imports, entropy, packing)."""
    inds = {"suspicious_imports": [], "packed": False, "entropy": None}
    if not pefile:
        return inds
    pe = pefile.PE(path)
    imports = []
    if hasattr(pe, "DIRECTORY_ENTRY_IMPORT"):
        for entry in pe.DIRECTORY_ENTRY_IMPORT:
            for imp in entry.imports:
                if imp.name:
                    imports.append(imp.name.decode(errors="ignore"))
    inds["suspicious_imports"] = [i for i in imports if i in SUSPICIOUS_IMPORTS]
    ents = [s.get_entropy() for s in pe.sections]
    inds["entropy"] = sum(ents)/len(ents) if ents else None
    inds["packed"] = inds["entropy"] and inds["entropy"] > 6.5
    return inds

def heuristic_score(path):
    """Calculate heuristic malware score based on rules."""
    strings = extract_strings(path)
    net_hits = sum(1 for s in strings for pat in NETWORK_INDICATORS if re.search(pat, s))
    pe_inds = pe_indicators(path)
    score = 0.0
    score += 0.25 if net_hits >= 3 else 0.1 if net_hits >= 1 else 0
    score += 0.3 if pe_inds["suspicious_imports"] else 0
    score += 0.2 if pe_inds["packed"] else 0
    score += min((pe_inds["entropy"] or 0)/10, 0.15)
    return min(score, 1.0), {"net_hits": net_hits, **pe_inds}

def ai_classification(path):
    """Run AI model on extracted features."""
    _, features = heuristic_score(path)
    df = pd.DataFrame([{
        "net_hits": features["net_hits"],
        "suspicious_imports": len(features["suspicious_imports"]),
        "packed": int(features["packed"]),
        "entropy": features["entropy"] or 0
    }])
    prediction = model.predict(df)[0]

    # Handle case where model was trained on only one class
    proba = model.predict_proba(df)[0]
    if len(proba) == 1:
        probability = proba[0]  # always 1.0
    else:
        probability = proba[1]  # probability of "malicious" class

    return prediction, probability

def detect_static_malware(path, threshold=0.7):
    """Unified detection: heuristic + AI model."""
    heuristic, features = heuristic_score(path)
    prediction, prob = ai_classification(path)
    print(f"[Hackslayer] Heuristic score: {heuristic:.2f}, AI probability: {prob:.2f}")
    if prob > threshold or heuristic > 0.6:
        return "Malicious", {"heuristic": heuristic, "ai_prob": prob, **features}
    else:
        return "Clean", {"heuristic": heuristic, "ai_prob": prob, **features}
